generator client {
  provider = "prisma-client-js"
  // output = "../generated/client"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model User {
  id                 String                  @id @default(uuid())
  email              String                  @unique
  username           String                  @unique
  hashedPassword     String
  salt               String                  @default("")
  createdAt          DateTime                @default(now())
  lastActiveAt       DateTime                @default(now())
  avatarUrl          String?
  secret2FA          String?
  enabled2FA         Boolean                 @default(false)
  friends            Friendship[]            @relation("UserToFriends")
  friendOf           Friendship[]            @relation("FriendsToUser")
  matches1           Match[]                 @relation("MatchUser1")
  matches2           Match[]                 @relation("MatchUser2")
  matchesWon         Match[]                 @relation("MatchWinner")
  tournamentsCreated Tournament[]
  leaderboard        Leaderboard[]
  tournaments        TournamentParticipant[]
}

model Leaderboard {
  id     String @id @default(uuid())
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId String @unique
  score  Int    @default(0)
}

model Friendship {
  id        String           @id @default(uuid())
  user      User             @relation("UserToFriends", fields: [userId], references: [id], onDelete: Cascade)
  userId    String
  friendOf  User             @relation("FriendsToUser", fields: [friendId], references: [id], onDelete: Cascade)
  friendId  String
  createdAt DateTime         @default(now())
  updatedAt DateTime         @default(now()) @updatedAt
  status    FriendshipStatus @default(PENDING)

  @@unique([userId, friendId])
}

enum FriendshipStatus {
  PENDING
  ACCEPTED
  REJECTED
}

model Match {
  id             String      @id @default(uuid())
  mode           MatchMode   @default(CLASSIC)
  duration       Int         @default(0)
  user1Id        String
  user1          User        @relation("MatchUser1", fields: [user1Id], references: [id], onDelete: Cascade)
  user2Id        String
  user2          User        @relation("MatchUser2", fields: [user2Id], references: [id], onDelete: Cascade)
  user1Score     Int         @default(0)
  user2Score     Int         @default(0)
  user1Character Character?
  user2Character Character?
  winnerId       String?
  winner         User?       @relation("MatchWinner", fields: [winnerId], references: [id], onDelete: Cascade)
  tournamentId   String?
  tournament     Tournament? @relation(fields: [tournamentId], references: [id], onDelete: Cascade)
  roundNumber    Int?
  createdAt      DateTime    @default(now())
  updatedAt      DateTime    @default(now()) @updatedAt
  settings       String

  @@unique([user1Id, user2Id, tournamentId])
}

enum Character {
  NONE
  MARIO
  LINK
  PIKACHU
  SONIC
  KIRBY
  YOSHI
  DK
  MEWTWO
  BOWSER
  SAMUS
  CAPFALCON
  SNAKE
}

enum MatchMode {
  CLASSIC
  CRAZY
}

model Tournament {
  id              String                  @id @default(uuid())
  name            String?
  createdAt       DateTime                @default(now())
  updatedAt       DateTime                @default(now()) @updatedAt
  matches         Match[]
  createdBy       User                    @relation(fields: [createdById], references: [id], onDelete: Cascade)
  createdById     String
  settings        String
  maxParticipants Int                     @default(8)
  status          TournamentStatus        @default(PENDING)
  currentRound    Int                     @default(1)
  participants    TournamentParticipant[]
}

enum TournamentStatus {
  PENDING
  ACTIVE
  COMPLETED
}

model TournamentParticipant {
  id           String     @id @default(uuid())
  tournament   Tournament @relation(fields: [tournamentId], references: [id], onDelete: Cascade)
  tournamentId String
  user         User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId       String
  alias        String
  character    Character?

  @@unique([tournamentId, userId])
  @@unique([tournamentId, alias])
}
